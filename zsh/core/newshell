#!/bin/zsh

typeset -a -g -U       zinclude_path
typeset -a -g -U -H    zrequired_files
typeset -A -g -H       dotto_vars  

if [[ $dotto_vars[zconfig_booted] != 1 ]]; then
  function dotto_newshell {
    local zcfile 
    
    FPATH=$ZCONFIGDIR/functions:$FPATH
  
    setopt function_argzero typeset_silent
  
    for zcfile in `find $DOTTODIR/local/build/zsh/$ZSH_VERSION -name \*.zwc 2>/dev/null `; do
        FPATH=$FPATH:$zcfile
    done

    for zcfile in $ZCONFIGDIR/functions/*; do
      autoload -Uk `basename $zcfile`
    done

    unset zcfile

    # globally used variables
    zinclude_path=("$ZCONFIGDIR")

    # load default prefs and local prefs
    zrunsystem prefs
    [[ -d $DOTTODIR/prefs ]] && source $DOTTODIR/prefs
    zsource prefs

    zrunsystem newshell
  
    dotto_vars[zconfig_booted]=1
  }
  
  dotto_newshell
  unfunction dotto_newshell
fi
